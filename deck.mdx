import { Appear, Image } from 'mdx-deck'
import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, nightOwl } from "@code-surfer/themes";
import customTheme from './theme'
import './styles.css'

import gatsbyI18nStarter from './images/gatsby-i18n-starter.png'
import gatsbyPluginI18n from './images/gatsby-plugin-i18n.png'
import howItWorks from './images/how-it-works.png'
import buildBefore from './images/build-before.png'
import buildAfter from './images/build-after.png'

export const themes = [nightOwl, customTheme];

# 🌏 Navigating i18n in SEA with Gatsby

## [<RK⚡️ issue={5} specialEdition="JAMstack / Gatsby" />](https://reactknowledgeable.org/meetups/5/)

[@zainfathoni](https://twitter.com/zainfathoni)

[www.zainfathoni.com](https://www.zainfathoni.com)

---

# I am [Zain Fathoni](https://www.zainfathoni.com) 🤝

<ul>
  <Appear>
    <li>
      🇮🇩 Indonesian family with 2 kids 👨‍👩‍👧‍👦
    </li>
    <li>
      🇸🇬 Working @{' '}
      <a href="https://www.ninjavan.co">
        Ninja Van
      </a>{' '}
      Singapore
    </li>
    <li>🔁 Backend turned Frontend 👨🏻‍💻</li>
    <li>⚛️ Co-organize <a href="https://reactjs.id">ReactJS Indonesia</a> meetups</li>
  </Appear>
</ul>

---

# 😉 What this talk is

- 🧭 My personal journey in developing [Ninja Van website](https://www.ninjavan.co)
- 🛠 Configuring Gatsby to serve an internationalized website
- 🔁 Handling automatic redirection for website with multiple domains

---

# ☝🏼 What this talk is _not_

- 🌐 Setting up i18n library such as [`react-intl`](https://github.com/formatjs/react-intl)
- 📝 Setting up localization platform such as [Lokalise](https://lokalise.com/)

---

# 😫 Problems

<ul>
  <Appear>
    <li>🇮🇩 Ninja 🇲🇾 Van 🇹🇭 serves 🇵🇭 <a href="https://www.ninjavan.co/en-sg/international-deliveries">6 🇻🇳 countries</a> 🇸🇬</li>
    <li>🌐 Some of them have low <a href="https://www.ef.sg/epi/regions/asia/">English literacy</a></li>
    <li>🧐 Google needs <a href="https://support.google.com/webmasters/answer/182192?hl=en">different URLs</a> for different languages</li>
  </Appear>
</ul>

---

# 💡 Solution 1

<ul class='center'>
  <Appear>
    <li>🛠 Since we're using Gatsby</li>
    <li>🚀 Why don't we pick a relevant starter?</li>
    <li class='image'>
      <a href="https://www.gatsbyjs.org/starters/smakosh/gatsby-starter-i18n/">
        <Image src={gatsbyI18nStarter} style={{ backgroundSize: 'contain', height: '50vh', width: '80vw' }} />
      </a>
    </li>
  </Appear>
</ul>

---

# ✨ Solution 2

<ul class='center'>
  <Appear>
    <li>😢 But it doesn't differentiate URLs on different languages</li>
    <li>🔌 Pick an officially recommended plugin for that</li>
    <li class='image'>
      <a href="https://www.gatsbyjs.org/docs/localization-i18n/#gatsby-plugin-i18n">
        <Image src={gatsbyPluginI18n} style={{ backgroundSize: 'contain', height: '50vh', width: '80vw' }} />
      </a>
    </li>
  </Appear>
</ul>

---

# 🛠 Implement

<ul class='center'>
  <Appear>
    <li>🔨 Name your files with <code>.<strong>langKey</strong>.js</code></li>
    <li>🔧 the url will be <code>/<strong>langKey</strong>/path/fileName</code></li>
    <li class='image'>
      <a href="https://github.com/angeloocana/gatsby-plugin-i18n#how-it-works">
        <Image src={howItWorks} style={{ backgroundSize: 'contain', height: '50vh', width: '80vw' }} />
      </a>
    </li>
    <li>😏 It looks simple, let's do it!</li>
  </Appear>
</ul>

---

<CodeSurferColumns themes={[github, nightOwl]}>

<Step>

```bash 1 title="Paths we need" subtitle="Let's implement the home page"
https://www.ninjavan.co
```

```bash 1 title="Files we create" subtitle="Original implementation"
src/pages/index.js
```

</Step>

<Step>

```bash 2[25:26],3[25:26],4[25:26],5[25:26],6[25:26],7[25:26] title="Paths we need" subtitle="6 different countries"
https://www.ninjavan.co
https://www.ninjavan.co/sg
https://www.ninjavan.co/my
https://www.ninjavan.co/ph
https://www.ninjavan.co/id
https://www.ninjavan.co/th
https://www.ninjavan.co/vn
```

```bash 2[17:18],3[17:18],4[17:18],5[17:18],6[17:18],7[17:18] title="Files we create" subtitle="6 more files"
src/pages/index.js
src/pages/index.sg.js
src/pages/index.my.js
src/pages/index.ph.js
src/pages/index.id.js
src/pages/index.th.js
src/pages/index.vn.js
```

</Step>

<Step>

```bash 2[25:30],3[25:30],4[25:30],5[25:30],6[25:30],7[25:30] title="Paths we need" subtitle="Those are only for English"
https://www.ninjavan.co
https://www.ninjavan.co/en-sg
https://www.ninjavan.co/en-my
https://www.ninjavan.co/en-ph
https://www.ninjavan.co/en-id
https://www.ninjavan.co/en-th
https://www.ninjavan.co/en-vn
```

```bash 2[17:21],3[17:21],4[17:21],5[17:21],6[17:21],7[17:21] title="Files we create" subtitle="Update file names"
src/pages/index.js
src/pages/index.en-sg.js
src/pages/index.en-my.js
src/pages/index.en-ph.js
src/pages/index.en-id.js
src/pages/index.en-th.js
src/pages/index.en-vn.js
```

</Step>

<Step>

```bash 6[25:30],8[25:30],10[25:30] title="Paths we need" subtitle="3 local languages"
https://www.ninjavan.co
https://www.ninjavan.co/en-sg
https://www.ninjavan.co/en-my
https://www.ninjavan.co/en-ph
https://www.ninjavan.co/en-id
https://www.ninjavan.co/id-id
https://www.ninjavan.co/en-th
https://www.ninjavan.co/th-th
https://www.ninjavan.co/en-vn
https://www.ninjavan.co/vi-vn
```

```bash 6[17:21],8[17:21],10[17:21] title="Files we create" subtitle="3 more files"
src/pages/index.js
src/pages/index.en-sg.js
src/pages/index.en-my.js
src/pages/index.en-ph.js
src/pages/index.en-id.js
src/pages/index.id-id.js
src/pages/index.en-th.js
src/pages/index.th-th.js
src/pages/index.en-vn.js
src/pages/index.vi-vn.js
```

</Step>

<Step>

```diff title="Paths we need" subtitle="10 different paths"
https://www.ninjavan.co
https://www.ninjavan.co/en-sg
https://www.ninjavan.co/en-my
https://www.ninjavan.co/en-ph
https://www.ninjavan.co/en-id
https://www.ninjavan.co/id-id
https://www.ninjavan.co/en-th
https://www.ninjavan.co/th-th
https://www.ninjavan.co/en-vn
https://www.ninjavan.co/vi-vn
```

```diff title="Files we create" subtitle="10 files in total"
src/pages/index.js
src/pages/index.en-sg.js
src/pages/index.en-my.js
src/pages/index.en-ph.js
src/pages/index.en-id.js
src/pages/index.id-id.js
src/pages/index.en-th.js
src/pages/index.th-th.js
src/pages/index.en-vn.js
src/pages/index.vi-vn.js
```

</Step>

</CodeSurferColumns>

---

# 🤔 Hold on

<ul>
  <Appear>
    <li>☝🏼 Those <strong>🔟 files</strong> are only for <strong>1️⃣ page</strong></li>
    <li>🧮 And we have at least <strong>14 pages</strong> in our website</li>
    <li>🤯 That means we would have <strong>140 files</strong> to build!</li>
    <li>🥺 And <strong>90%</strong> of those files are simply just like this:</li>
  </Appear>
</ul>

---

<CodeSurfer>

```js title="Dummy files content" subtitle="Import whatever implemented in the default page"
import Page from './index'
```

```js 3 title="Dummy files content" subtitle="😓 Then simply re-export it"
import Page from './index'

export default Page
```

```diff title="Dummy files content" subtitle="🥴 That's all!"
```

</CodeSurfer>

---

# 🕵🏻‍♂️ There must be another way

<ul>
  <Appear>
    <li>✨ Luckily, we are in the open source world!</li>
    <li>🔬 I tried reverse engineering the plugin</li>
    <li>💡 Apparently, we only needed a small part of it</li>
    <li>🧩 Let's implement it from scratch!</li>
    <li>📝 We're gonna use <a href="https://www.gatsbyjs.org/docs/node-apis/#onCreatePage"><code>onCreatePage</code></a> Node API</li>
  </Appear>
</ul>

---

<CodeSurfer>

```js title="gatsby-node.js" subtitle="onCreatePage() receives page & actions properties"
exports.onCreatePage = ({ page, actions }) => {

}
```

```js title="gatsby-node.js" subtitle="Import list of locales we serve"
const { locales } = require('./src/data/config')

exports.onCreatePage = ({ page, actions }) => {

}
```

```js title="gatsby-node.js" subtitle="Loop on the locales"
const { locales } = require('./src/data/config')

exports.onCreatePage = ({ page, actions }) => {
  const skip = false // TODO: Skip unnecessary pages
  if (!skip) {
    locales.forEach(locale => {
      // TODO: Copy to all supported locales
    })
  }
}
```

```js title="gatsby-node.js" subtitle="Clone the page object"
const { locales } = require('./src/data/config')

exports.onCreatePage = ({ page, actions }) => {
  const skip = false // TODO: Skip unnecessary pages
  if (!skip) {
    locales.forEach(locale => {
      const newPage = Object.assign({}, page)
    })
  }
}
```

```js title="gatsby-node.js" subtitle="Insert the /locale/ path into the first segment of the URL"
const { locales } = require('./src/data/config')

exports.onCreatePage = ({ page, actions }) => {
  const skip = false // TODO: Skip unnecessary pages
  if (!skip) {
    locales.forEach(locale => {
      const newPage = Object.assign({}, page)
      newPage.path = page.path.replace(/^\//, `/${locale}/`)
    })
  }
}
```

```js title="gatsby-node.js" subtitle="Call createPage() to create the new page"
const { locales } = require('./src/data/config')

exports.onCreatePage = ({ page, actions }) => {
  const skip = false // TODO: Skip unnecessary pages
  if (!skip) {
    locales.forEach(locale => {
      const newPage = Object.assign({}, page)
      newPage.path = page.path.replace(/^\//, `/${locale}/`)
      actions.createPage(newPage)
    })
  }
}
```

```js title="gatsby-node.js" subtitle="Skip unnecessary pages"
const { locales } = require('./src/data/config')
const isIndexPage = (page, locale) => page.path === `/${locale}`
const is404Page = page => page.path.startsWith('/404')

exports.onCreatePage = ({ page, actions }) => {
  const skip = locales.some(locale => isIndexPage(page, locale)) || is404Page(page)
  if (!skip) {
    locales.forEach(locale => {
      const newPage = Object.assign({}, page)
      newPage.path = page.path.replace(/^\//, `/${locale}/`)
      actions.createPage(newPage)
    })
  }
}
```

```diff title="gatsby-node.js" subtitle="💯 That's it!"
```

</CodeSurfer>

---

# ⚖️ Compare Build Performance ⚖️

---

# 🔴 Old Implementation

<ul class='center'>
  <Appear>
    <li>✌🏼 Using <a href="https://github.com/angeloocana/gatsby-plugin-i18n"><code>gatsby-plugin-i18n</code></a> with only <strong>2 pages</strong> localized</li>
    <li>🧮 That means <strong>18 JavaScript files</strong> executed for nothing</li>
    <li class='image'>
      <Image src={buildBefore} style={{ backgroundSize: 'contain', height: '20vh', width: '80vw' }} />
    </li>
    <li>❗️ <strong>~163 seconds</strong> for building <strong>39 HTML pages</strong> ❗️</li>
  </Appear>
</ul>

---

# 🟢 New Implementation

<ul class='center'>
  <Appear>
    <li>✨ Using <a href="https://www.gatsbyjs.org/docs/node-apis/#onCreatePage"><code>onCreatePage</code></a> Node API</li>
    <li>🚫 No reexecuting JavaScript files</li>
    <li>📑 Only copying the created page objects</li>
    <li class='image'>
      <Image src={buildAfter} style={{ backgroundSize: 'contain', height: '20vh', width: '80vw' }} />
    </li>
    <li>✅ <strong>~78 seconds</strong> for building <strong>138 HTML pages</strong> ✅</li>
  </Appear>
</ul>

---

# 🔑 Key Takeaway

<ul>
  <Appear>
    <li>⚖️ It doesn't mean that <a href="https://github.com/angeloocana/gatsby-plugin-i18n"><code>gatsby-plugin-i18n</code></a> is bad</li>
    <li>🦾 It's still pretty <strong>useful</strong> for some use cases<br />📑 e.g. using different layouts for each language</li>
    <li>☝🏼 <strong>Do not take</strong> any Gatsby plugins <strong>for granted</strong></li>
    <li>📈 <strong>Evaluate</strong> build and runtime performance continuously</li>
    <li>💪🏼 Do not afraid to implement features <strong>from scratch</strong></li>
  </Appear>
</ul>

---

# Thanks

- ⭐️ [JAMstack Singapore](https://jamstacksingapore.com/)
- ⚡️ [React Knowledgeable](https://reactknowledgeable.org/)
- 🆂 [Stripe Singapore](https://twitter.com/StripeSingapore)

### [i18n-gatsby.netlify.com](https://i18n-gatsby.netlify.com)
